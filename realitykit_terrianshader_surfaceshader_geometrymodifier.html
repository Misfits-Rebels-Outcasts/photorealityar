<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    
    <!-- Favicon -->
    <!--
    <link rel="shortcut icon" href="./assets/favicon/favicon.ico" type="image/x-icon" />
    -->
    <link rel="shortcut icon" href="./photo.ico" type="image/x-icon" />

    <!-- Map CSS -->
    <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/v0.53.0/mapbox-gl.css" />
    
    <!-- Libs CSS -->
    <link rel="stylesheet" href="./assets/css/libs.bundle.css" />
    
    <!-- Theme CSS -->
    <link rel="stylesheet" href="./assets/css/theme.bundle.css" />
    
    <!-- Title -->
    
    <title>Create an AR Terrian with RealityKit Surface Shader and Geometry Modifier</title>
    <meta content="Create an AR Terrian with RealityKit Surface Shader and Geometry Modifier"
                name="description">
    <meta content="RealityKit, Surface Shader, Geometry Modifier, AR Terrian, Terrian Shader"
                name="keywords">
                
  </head>
  <body>




    <!-- NAVBAR -->
    <nav class="navbar navbar-expand-lg navbar-dark">
      <div class="container-fluid">
    
        <!-- Brand -->
        <a class="navbar-brand" href="./index.html">
            <!--
          <img src="./assets/img/brand.svg" class="navbar-brand-img" alt="...">
            <img src="./images/sigmanode.png"  class="navbar-brand-img"  />
            -->
            Photo Reality AR
        </a>
        
        <!-- Toggler -->
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
    
        <!-- Collapse -->
        <div class="collapse navbar-collapse" id="navbarCollapse">
    
          <!-- Toggler -->
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
            <i class="fe fe-x"></i>
          </button>
    
          <!-- Navigation -->
          <ul class="navbar-nav ms-auto">

            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" id="navbarPages" data-bs-toggle="dropdown" href="#" aria-haspopup="true" aria-expanded="false">
                Open-Source
              </a>
              <div class="dropdown-menu dropdown-menu-lg" aria-labelledby="navbarPages">
                <div class="row gx-0">
                  <div class="col-6">
                    <div class="row gx-0">
                      <div class="col-12 col-lg-6">
    
                        <!-- Heading -->
                        <h6 class="dropdown-header">
                          Photo
                        </h6>
    
                        <a class="dropdown-item" href="./realitykit_terrianshader_surfaceshader_geometrymodifier.html">
                          RealityKit Terrian Shader
                        </a>
                        <a class="dropdown-item" href="./photocurves.html">
                          Photo Curves
                        </a>
                        <a class="dropdown-item" href="./photoshaders.html">
                          Photo Shaders
                        </a>
    
                        <a class="dropdown-item mb-5" href="../photodraw.html">
                          Photo Draw
                        </a>

    
                      </div>
             
                    </div>
                  </div>
                  <div class="col-6">
                    <div class="row gx-0">
                      <div class="col-12 col-lg-6">
    
                        <!-- Heading -->
                        <h6 class="dropdown-header">
                          Digital Compositing
                        </h6>
    
                        <!-- List -->
  

                        <a class="dropdown-item mb-5" href="./digitalcompositing.html">
                          Open Pipeline
                        </a>
    
                        <h6 class="dropdown-header">
                          Download
                        </h6>

                        <!-- List -->
                        <a class="dropdown-item" href="./download.html">
                          Mac or iOS
                        </a>
                    
                      </div>
               
                    </div>
                  </div>
                </div>
              </div> <!-- / .row -->
            </li>
            
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" id="navbarDocumentation" data-bs-toggle="dropdown" href="#" aria-haspopup="true" aria-expanded="false">
                Filters & Effects
              </a>
              <div class="dropdown-menu dropdown-menu-md" aria-labelledby="navbarDocumentation">
                <div class="list-group list-group-flush">
                  <a class="list-group-item" href="./photofilters.html">
    
                    <!-- Icon -->
                    <!--
                    <div class="icon icon-sm text-primary">
                      <svg width="24" height="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><g fill="none" fill-rule="evenodd"><path d="M0 0h24v24H0z"/><path d="M8 3v.5A1.5 1.5 0 009.5 5h5A1.5 1.5 0 0016 3.5V3h2a2 2 0 012 2v16a2 2 0 01-2 2H6a2 2 0 01-2-2V5a2 2 0 012-2h2z" fill="#335EEA" opacity=".3"/><path d="M11 2a1 1 0 012 0h1.5a.5.5 0 01.5.5v1a.5.5 0 01-.5.5h-5a.5.5 0 01-.5-.5v-1a.5.5 0 01.5-.5H11z" fill="#335EEA"/><rect fill="#335EEA" opacity=".3" x="7" y="10" width="5" height="2" rx="1"/><rect fill="#335EEA" opacity=".3" x="7" y="14" width="9" height="2" rx="1"/></g></svg>                </div>
                    -->
                    <div class="icon icon-sm text-primary">
                      <svg width="24" height="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><g fill="none" fill-rule="evenodd"><path d="M0 0h24v24H0z"/><rect fill="#335EEA" x="4" y="4" width="7" height="7" rx="1.5"/><path d="M5.5 13h4a1.5 1.5 0 011.5 1.5v4A1.5 1.5 0 019.5 20h-4A1.5 1.5 0 014 18.5v-4A1.5 1.5 0 015.5 13zm9-9h4A1.5 1.5 0 0120 5.5v4a1.5 1.5 0 01-1.5 1.5h-4A1.5 1.5 0 0113 9.5v-4A1.5 1.5 0 0114.5 4zm0 9h4a1.5 1.5 0 011.5 1.5v4a1.5 1.5 0 01-1.5 1.5h-4a1.5 1.5 0 01-1.5-1.5v-4a1.5 1.5 0 011.5-1.5z" fill="#335EEA" opacity=".3"/></g></svg>                </div>

                    <!-- Content -->
                    <div class="ms-4">
    
                      <!-- Heading -->
                      <h6 class="fw-bold text-uppercase text-primary mb-0">
                        Photo Filters
                      </h6>
    
                      <!-- Text -->
                      <p class="fs-sm text-gray-700 mb-0">
                        Full list of Filters
                      </p>
                    </div>
        
    
                  </a>
                  <a class="list-group-item" href="./photoeffects.html">
    
                    <!-- Icon -->
                    <div class="icon icon-sm text-primary">
                      <svg width="24" height="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><g fill="none" fill-rule="evenodd"><path d="M0 0h24v24H0z"/><rect fill="#335EEA" x="4" y="4" width="7" height="7" rx="1.5"/><path d="M5.5 13h4a1.5 1.5 0 011.5 1.5v4A1.5 1.5 0 019.5 20h-4A1.5 1.5 0 014 18.5v-4A1.5 1.5 0 015.5 13zm9-9h4A1.5 1.5 0 0120 5.5v4a1.5 1.5 0 01-1.5 1.5h-4A1.5 1.5 0 0113 9.5v-4A1.5 1.5 0 0114.5 4zm0 9h4a1.5 1.5 0 011.5 1.5v4a1.5 1.5 0 01-1.5 1.5h-4a1.5 1.5 0 01-1.5-1.5v-4a1.5 1.5 0 011.5-1.5z" fill="#335EEA" opacity=".3"/></g></svg>                </div>
    
                    <div class="ms-4">
                        <!-- Heading -->
                        <h6 class="fw-bold text-uppercase text-primary mb-0">
                            Photo Effects
                        </h6>

                        <!-- Text -->
                        <p class="fs-sm text-gray-700 mb-0">
                        Full list of Shader Effects
                        </p>

                  </div>
                  </a>
                </div>
              </div>
            </li>
          </ul>
          
          <a  class="navbar-btn btn btn-sm btn-info lift ms-auto" href="./gallery.html">
              Gallery
          </a>
         
 
        </div>
    
      </div>
    </nav>
    
        <section class="mt-n11 pt-12 pb-8 pt-md-14 pb-md-11 bg-black bg-pattern-2">
          <div class="container text-white">
            <div class="row justify-content-center">
              <div class="col-12 col-md-10 col-lg-9 col-xl-8">

                <h1 class="display-4">
                    RealityKit Terrian Shader
                </h1>

       
                <p>
                
                This project shows you how to use Fractal Brownian Motion (fBM) to generate an Augmented Reality (AR) Terrain using iOS RealityKit Custom Materials. RealityKit Custom Material includes a surface shader and geometry modifier, also known as fragment and vertex shaders in OpenGL.
                
                </p>
                <figure class="figure mb-7">
                    <img class="figure-img img-fluid rounded lift lift-lg" src="ar/realitykitshaders/terrian_shader.png" alt="Terrian Shader">
                </figure>
                <!--
                <h3 class="fw-bold">
                    Quick Summary
                </h3>
     
                <p>
                In short it involves building a Mesh for the Terrain, generating a height map at each uv position of the mesh by offsetting the height-map in the x and y direction, and finally elevating the plane vertically randomly at various vertices to produce an uneven surface. The random elevation levels generated for this terrain is produced directly using a Fractal Brownian motion (fBM) function, fBMheightmapx, and a geometryModifier.
                </p>
                <p>
                The surface shader assign colors to the heightmap according to different coloring schemes. In this case it uses a red-brownish color schem for the terrain. The set of colors (palette) used can make the generated effect change drammatically. e.g using a yellow to red spectrum can produces a fire-like effect, using a blue and white palette will produces cloud-like effect                </p>
    
                <p>
                -->
                <a href="https://github.com/Misfits-Rebels-Outcasts/RealityKit-Terrian-Shader" class="btn btn-info lift" rel="nofollow">
                  Github Project <i class="fe fe-arrow-right ms-2"></i>
                </a>
                </p>
                
                <h2 class="fw-bold">
                Fractal Brownian Motion (fBM)
                </h2>
                <p>
                fBM (Fractal Brownian Motion) is used extensively in computer graphics to model natural phenomenons and textures such as terrain , coastline, fire, smoke, clouds, water flow, water waves , rapids, dinosaur skin, wrinkles etc. It is quite amazing to note how such a simple random function can be used in so many areas to emulate the various forms of nature.
                </p>
                <p>

                This project shows how you can use the fBM function to very simply generate a terrain using iOS RealityKit custom materials (which includes the surface shader and geometry modifier, also known as fragment and vertex shaders in OpenGL)
                </p>
                <h3 class="fw-bold">
                Parameters
                </h3>
                <p>
                The form of fBM function we are using has mainly the parameters
                </p>
                <ul class="list-unstyled mb-7">
                              <li class="d-flex">

                                <div class="badge badge-rounded-circle bg-success-soft mt-1 me-4">
                                  <i class="fe fe-check"></i>
                                </div>
                              
                                <p>
                                uv - texture coordinates (a value of [0,0] to [1,1], representing the four corners of an image we will like to generate)
                                </p>
                                

                              </li>
                              <li class="d-flex">

                                <div class="badge badge-rounded-circle bg-success-soft mt-1 me-4">
                                  <i class="fe fe-check"></i>
                                </div>
                                </p>
                                time - in seconds (this value will animate the fBM generate image with respect to time)
                                </p>
                                

                              </li>
                </ul>

                <h3 class="fw-bold">
                Properties of the fBM
                </h3>
                <p>
                A fBM can return a single value (one dimensional value) or multiple values (e.g a 3 dimensional vector).  You can view a fBM as a random number generator that depends on the current pixel position of the image. However, it is not completely random because the function varies quite smoothly with respect to its neighbours.
                </p>

                <p>
                So if the user pass in uv-coordinate  values of (0.10,0.10) and (0.11,0.10) the returned value should be quite near to each other. For a 3 dimensional vector , the value of each component will be quite similar to its neighbour’s.
                </p>
                <p>
                Apart from varying smoothly with respect to space (i.e position or uv-coordinates), the fBM also varies quite smoothly with respect to time. So a returned value at time = 0.10 sec will be quite similar to a value at time = 0.11 sec. This gives it the property of having a smooth animation w.r.t. time.
                </p>
                <p>
                Furthermore, the continuity of many implementations fBM is not restricted to just continuity of values, but also the continuity of its gradient as well as the continuity of (radius of) curvature. This make the fBM function very ‘smooth’ and thus very suitable for artistic renderings.
                </p>
                <p>
                A fBM has fractal like properties. If you zoom in to small area, you will be able to notice similar patterns when the image has not been zoomed in.
                </p>


                <h2 class="fw-bold">
                    Generating the Terrain
                </h2>
                <p>
                This article is mainly about using fBM to generate a terrain with RealityKit 2. The language is in Swift and Metal.
                </p>
                <ol>
                    <li>
                        <p>
                        The steps involved is to first generate a 2D plane with 64x64 cells.
                        </p>
                        <p>
                        <div style="border:1px solid gray">
                           <pre style="overflow:auto; word-wrap:normal; white-space:pre;font-family: monospace;font-size:12px;margin-left:10px;margin-right:10px">
                               
    let plane = buildMesh(numCells: [64, 64], cellSize: 0.01)
                           </pre>
                        </div>
                        </p>
                    </li>
                    <li>
                        <p>
                        Assign the plane with a Custom Material. This custom material will automatically associate a Surface Shader function and a Geometry Modifier function to the plane
                        </p>
                        <p>
                        <div style="border:1px solid gray">
                           <pre style="overflow:auto; word-wrap:normal; white-space:pre;font-family: monospace;font-size:12px;margin-left:10px;margin-right:10px">
                               
    let geometryModifier = CustomMaterial.GeometryModifier(named: "geometryModifier",
                                                            in: library)
                          
    let surfaceShader = CustomMaterial.SurfaceShader(named: "surfaceShader",
                                                        in: library)

    let customMaterials = try! CustomMaterial(from: baseMaterial,
                                                surfaceShader : surfaceShader,
                                                geometryModifier: geometryModifier)

    let plane = buildMesh(numCells: [64, 64], cellSize: 0.01)
                                      
    landEntity = ModelEntity(mesh: plane, materials : [customMaterials])
                           </pre>
                        </div>
                        </p>
                    </li>
                    <li>
                        <p>
                        The geometryModifier and surfaceShader is currently empty functions written in the Metal language. Running the app shows an empty plane.
                        </p>
                        <figure class="figure mb-7">
                            <img class="figure-img img-fluid rounded lift lift-lg" src="ar/realitykitshaders/terrrianplane.png" alt="Terrian Plane">
                        </figure>

                        
                    </li>
                    <li>
                        <p>
                        Add normals to the plane using the computeNormal function. At this time, we will like to introduce the fBMheightmapx function. This is the main fBM function used for generating a height map for the terrain. In normal situations, we will simply render this height map and we will get a terrain. However, for RealityKit surface shader, it is easier to add details (roughness) to the terrain using normals. This is achieved by computing normals of the height map with the computeNormal function in the surfaceShader function.
                        </p>
                        <p>
                        <div style="border:1px solid gray">
                           <pre style="overflow:auto; word-wrap:normal; white-space:pre;font-family: monospace;font-size:12px;margin-left:10px;margin-right:10px">
    
    //fBMheightmapx  - generates a height map at each position (uv position) of the shader.
    //This height-field has a normal at each uv coordinate position pointing away perpendicularly from the surface.
    //The normals is computed by offsetting the height-map a little in the x-direction and a little in the y-direction to compute the difference.
    //The normals computed thus does not necessary has magnitude / length of 1 (and need to be normalised to length 1).

    float3 normal = computeNormal(uvscale,time*timefactor/divfactor ,warpType,animVelocity,angle,screensize);
                            
    normal = normalize(normal);
                          
    params.surface().set_normal(normal); //set tangent space normal
                           </pre>
                        </div>
                        </p>
                        <p>
                        With the normals set, we now run the app and we get something that look like below.
                        </p>
                        <figure class="figure mb-7">
                            <img class="figure-img img-fluid rounded lift lift-lg" src="ar/realitykitshaders/terrian_surfaceshader.png" alt="Terrian Surface Shader">
                        </figure>
                    </li>
                    <li>
                        <p>
                        We now elevate the plane vertically at the various vertices of each cell randomly to produce a an uneven surface. The random values (elevation levels) generated for this terrain  is produced directly using the fBM function we mentioned earlier (fBMheightmapx). To elevate the plane, we have to use a geometry modifier (also known as vertex shader) to modify the position of each of these vertices. To do so, we define a geometryModifier function with the following code.
                        </p>
                        <p>
                        <div style="border:1px solid gray">
                           <pre style="overflow:auto; word-wrap:normal; white-space:pre;font-family: monospace;font-size:12px;margin-left:10px;margin-right:10px">
                               
    float4 val =
                fBMheightmapx(uvscale,time ,warpType,animVelocity,angle);

    //here , we are preparing the values for a displacement map
    //so that only the y-value (height) is modified, but not the x and z value
    //the value 0.063 is chosen by trial and error
    float3 offset = float3(0.0,0.063*val.r,0.0);
                         
    //this function applies the fBM generated offset to the plane to make it uneven
    params.geometry().set_model_position_offset(offset);
                           </pre>
                        </div>
                        </p>
                        <p>
                           We now get something that looks like below.  The terrain is almost complete.
                           </p>
                           <figure class="figure mb-7">
                               <img class="figure-img img-fluid rounded lift lift-lg" src="ar/realitykitshaders/terrian_geometrymodifier.png" alt="Terrian Surface Shader">
                           </figure>
                    </li>
                    <li>
                        <p>
                        For the final step, wee proceed to color the terrain. The fBM function we mentioned earlier can do many things, apart from producing a height map (and its associated normals), we can also use it to color the terrain by mapping each height value with a color.
                        </p>
                        <p>
                        For our case, we use a modified extended version of the fBM function named fBMFlow. This function applies a color palette to the fBM generated height-map and retrieve the color at the current uv position. This color is then used to colorize the terrain.
                        </p>

                        <p>
                        <div style="border:1px solid gray">
                           <pre style="overflow:auto; word-wrap:normal; white-space:pre;font-family: monospace;font-size:12px;margin-left:10px;margin-right:10px">
                               
    float4 val = fBMFlow(uv, float2(2048,2048), float3(0,0,0), time*timefactor);
                                     
    half3 color1 = half3(halfr,halfg,halfb);

    params.surface().set_base_color(color1);
                           </pre>
                        </div>
                        </p>
                        
                         <p>
                         With this done, we will get the terrain as shown below. (The image has been enhanced a little for better visibility).
                         </p>
                         <figure class="figure mb-7">
                             <img class="figure-img img-fluid rounded lift lift-lg" src="ar/realitykitshaders/terrian_shader.png" alt="Terrian Shader">
                         </figure>
                    </li>
  
                </ol>



                
              </div>
            </div> <!-- / .row -->
          </div> <!-- / .container -->
        </section>

    

    <!--
    <section class="mt-n11 pt-12 pb-8 pt-md-14 pb-md-11 bg-black bg-pattern-2">
    <section class="bg-gradient-dark-black py-8 py-md-11">
      <div class="container">
    <section class="pt-6 pt-md-8">
    -->

    <!--
    <section class="pt-6 pt-md-8">
    -->

    <!-- BORDER -->
    <div class="bg-black">
      <div class="container border-top border-gray-900-50"></div>
    </div>

    <!-- FOOTER -->
    <footer class="py-8 py-md-11 bg-black">
      <div class="container">
        <div class="row">
          <div class="col-12 col-md-4 col-lg-3">
    
        <!--
            <img src="./assets/img/brand.svg" alt="..." class="footer-brand img-fluid mb-2">
    

            <p class="text-gray-700 mb-2">
              A better way to build.
            </p>
        -->
            <!--
            <ul class="list-unstyled list-inline list-social mb-6 mb-md-0">
              <li class="list-inline-item list-social-item me-3">
                <a href="#!" class="text-decoration-none">
                  <img src="./assets/img/icons/social/instagram.svg" class="list-social-icon" alt="...">
                </a>
              </li>
              <li class="list-inline-item list-social-item me-3">
                <a href="#!" class="text-decoration-none">
                  <img src="./assets/img/icons/social/facebook.svg" class="list-social-icon" alt="...">
                </a>
              </li>
              <li class="list-inline-item list-social-item me-3">
                <a href="#!" class="text-decoration-none">
                  <img src="./assets/img/icons/social/twitter.svg" class="list-social-icon" alt="...">
                </a>
              </li>
              <li class="list-inline-item list-social-item">
                <a href="#!" class="text-decoration-none">
                  <img src="./assets/img/icons/social/pinterest.svg" class="list-social-icon" alt="...">
                </a>
              </li>
            </ul>
        -->
          </div>
          <div class="col-6 col-md-4 col-lg-2">
    
 
    
          </div>
          <div class="col-6 col-md-4 col-lg-2">
    
  
    
          </div>
          <div class="col-6 col-md-4 offset-md-4 col-lg-2 offset-lg-0">
    
    
          </div>
          <div class="col-6 col-md-4 col-lg-2">
    <!--
      
            <h6 class="fw-bold text-uppercase text-gray-700">
              Legal
            </h6>
    
       
            <ul class="list-unstyled text-muted mb-0">
              <li class="mb-3">
                <a href="#!" class="text-reset">
                  Documentation
                </a>
              </li>
              <li class="mb-3">
                <a href="#!" class="text-reset">
                  Changelog
                </a>
              </li>
              <li>
                <a href="#!" class="text-reset">
                  Pagebuilder
                </a>
              </li>
            </ul>
    -->
          </div>
        </div> <!-- / .row -->
      </div> <!-- / .container -->
    </footer>

    <!-- JAVASCRIPT -->
    <!-- Map JS -->
    <script src='https://api.mapbox.com/mapbox-gl-js/v0.53.0/mapbox-gl.js'></script>
    
    <!-- Vendor JS -->
    <script src="./assets/js/vendor.bundle.js"></script>
    
    <!-- Theme JS -->
    <script src="./assets/js/theme.bundle.js"></script>

  </body>
</html>
